{% extends "base.html" %} 

{% block title %}Checkout - Protein Perks{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 py-12">

  <h1 class="text-3xl font-bold mb-8">Checkout</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">


    <!-- ================= FORM ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Shipping Details</h2>

      <form id="checkout-form">

        <input name="name" placeholder="Full Name" required class="input">

        <input name="email" type="email" placeholder="Email" required class="input">

        <input name="phone" placeholder="Phone" required class="input">

        <textarea name="address" placeholder="Address" required class="input"></textarea>

        <div class="grid grid-cols-2 gap-3">
          <input name="city" placeholder="City" required class="input">
          <input name="state" placeholder="State" required class="input">
        </div>

        <input name="pincode" placeholder="Pincode" required class="input">


        <!-- Transaction ID -->
        <input 
          name="txn_id"
          id="txn-id"
          placeholder="UPI Transaction ID (For UPI Only)"
          class="input mt-2"
        >


        <!-- ================= UPI QR ================= -->

        <div class="mt-4 text-center border p-4 rounded bg-gray-50">

          <p class="font-semibold mb-2">
            Scan QR to Pay via UPI
          </p>

          <img 
            src="/static/images/upi_qr.jpeg"
            alt="UPI QR Code"
            class="mx-auto w-48 h-48 object-contain border rounded"
          >

          <p class="text-sm text-gray-600 mt-2">
            UPI ID: 9424862686@ybl
          </p>

        </div>


        <!-- ================= UPI BUTTON ================= -->

        <button id="upi-btn"
          type="button"
          class="w-full mt-3 bg-blue-600 text-white py-3 rounded">

          Place Order (After UPI Payment)

        </button>


        <!-- ================= COD ================= -->

        <button id="cod-btn"
          type="button"
          class="w-full mt-3 bg-green-600 text-white py-3 rounded">

          Cash On Delivery (+₹{{ cod_charge }})

        </button>

      </form>

    </div>


    <!-- ================= SUMMARY ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Order Summary</h2>

      {% for item in cart_items %}
      <div class="flex justify-between py-2 border-b">
        <span>{{ item.product.name }} ({{ item.quantity }})</span>
        <span>₹{{ item.subtotal }}</span>
      </div>
      {% endfor %}

      <div class="mt-4 text-lg font-bold flex justify-between">
        <span>Total</span>
        <span>₹{{ total }}</span>
      </div>

      <div class="mt-2 text-sm text-gray-600">
        COD Charge: ₹{{ cod_charge }}
      </div>

    </div>


  </div>

</div>

{% endblock %}



{% block extra_scripts %}

<script>

document.addEventListener("DOMContentLoaded", function () {

  const form = document.getElementById("checkout-form");
  const upiBtn = document.getElementById("upi-btn");
  const codBtn = document.getElementById("cod-btn");
  const txnInput = document.getElementById("txn-id");


  // ================= FORM VALIDATION =================

  function validateForm() {

    const formData = new FormData(form);

    for (let val of formData.values()) {

      if (val.trim() === "") {
        alert("Please fill all details");
        return false;
      }

    }

    return true;
  }


  // ================= UPI =================

  if (upiBtn) {

    upiBtn.addEventListener("click", async function () {

      if (!validateForm()) return;


      if (txnInput.value.trim() === "") {

        alert(`
Please complete UPI payment first.

Scan QR and enter Transaction ID.
Send screenshot on WhatsApp:
7898928129 (Harshil Majawdiya)
        `);

        return;
      }


      const formData = new FormData(form);
      formData.append("payment_mode", "UPI");


      const res = await fetch("/checkout/place-order", {
        method: "POST",
        body: formData
      });


      const data = await res.json();


      if (data.success) {

        alert("Order Placed! Order ID: " + data.order_id);
        window.location.href = "/";

      } else {

        alert(data.message);

      }

    });

  }


  // ================= COD =================

  if (codBtn) {

    codBtn.addEventListener("click", async function () {

      if (!validateForm()) return;


      const formData = new FormData(form);
      formData.append("payment_mode", "COD");


      const res = await fetch("/checkout/place-order", {
        method: "POST",
        body: formData
      });


      const data = await res.json();


      if (data.success) {

        alert("Order Placed! Order ID: " + data.order_id);
        window.location.href = "/";

      } else {

        alert(data.message);

      }

    });

  }

});
</script>


{% endblock %}
