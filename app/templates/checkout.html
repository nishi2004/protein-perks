{% extends "base.html" %} 

{% block title %}Checkout - Protein Perks{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 py-12">

  <h1 class="text-3xl font-bold mb-8">Checkout</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">


    <!-- ================= FORM ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Shipping Details</h2>

      <form id="checkout-form">

        <input name="name" placeholder="Full Name" required class="input">

        <input name="email" type="email" placeholder="Email" required class="input">

        <input name="phone" placeholder="Phone" required class="input">

        <textarea name="address" placeholder="Address" required class="input"></textarea>

        <div class="grid grid-cols-2 gap-3">
          <input name="city" placeholder="City" required class="input">
          <input name="state" placeholder="State" required class="input">
        </div>

        <input name="pincode" placeholder="Pincode" required class="input">


        <!-- Transaction ID -->
        <input 
          name="txn_id"
          id="txn-id"
          placeholder="UPI Transaction ID (For UPI Only)"
          class="input mt-2"
        >


        <!-- ================= UPI QR ================= -->

        <div class="mt-4 text-center border p-4 rounded bg-gray-50">

          <p class="font-semibold mb-2">
            Scan QR to Pay via UPI
          </p>

          <img 
            src="/static/images/upi_qr.jpeg"
            alt="UPI QR Code"
            class="mx-auto w-48 h-48 object-contain border rounded"
          >

          <p class="text-sm text-gray-600 mt-2">
            UPI ID: 9424862686@ybl
          </p>

        </div>


        <!-- ================= UPI BUTTON ================= -->

        <button id="upi-btn"
          type="button"
          class="w-full mt-3 bg-blue-600 text-white py-3 rounded">

          Place Order (After UPI Payment)

        </button>


        <!-- ================= COD ================= -->

        <button id="cod-btn"
          type="button"
          class="w-full mt-3 bg-green-600 text-white py-3 rounded">

          Cash On Delivery (+‚Çπ{{ cod_charge }})

        </button>

      </form>

    </div>


    <!-- ================= SUMMARY ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Order Summary</h2>

      {% for item in cart_items %}
      <div class="flex justify-between py-2 border-b">
        <span>{{ item.product.name }} ({{ item.quantity }})</span>
        <span>‚Çπ{{ item.subtotal }}</span>
      </div>
      {% endfor %}

      <div class="mt-4 text-lg font-bold flex justify-between">
        <span>Total</span>
        <span>‚Çπ{{ total }}</span>
      </div>

      <div class="mt-2 text-sm text-gray-600">
        COD Charge: ‚Çπ{{ cod_charge }}
      </div>

    </div>


  </div>

</div>

{% endblock %}



{% block extra_scripts %}

<script>

document.addEventListener("DOMContentLoaded", function () {

  console.log("‚úÖ Checkout JS Loaded");

  const form = document.getElementById("checkout-form");
  const upiBtn = document.getElementById("upi-btn");
  const codBtn = document.getElementById("cod-btn");
  const txnInput = document.getElementById("txn-id");


  if (!form || !upiBtn || !codBtn) {
    console.error("‚ùå Button/Form Missing");
    return;
  }


  // ================= VALIDATE =================

  function validate() {

    const inputs = form.querySelectorAll("input, textarea");

    for (let i of inputs) {

      if (i.hasAttribute("required") && i.value.trim() === "") {
        alert("Please fill all details");
        return false;
      }

    }

    return true;
  }


  // ================= UPI =================

  upiBtn.onclick = async function () {

    console.log("üü¶ UPI Clicked");

    if (!validate()) return;


    if (txnInput.value.trim() === "") {

      alert("Please enter UPI Transaction ID after payment");
      return;
    }


    const formData = new FormData(form);
    formData.append("payment_mode", "UPI");


    try {

      const res = await fetch("https://proteinperks.in/checkout/place-order", {

        method: "POST",
        body: formData
      });


      const data = await res.json();

      console.log("üì¶ Response:", data);


      if (data.success) {

        alert(`
üéâ Order Confirmed!

Order ID: ${data.order_id}

Send payment screenshot on WhatsApp:
7898928129
        `);

        window.location.href = "/";

      } else {

        alert(data.message || "Order failed");

      }

    } catch (err) {

      console.error("‚ùå Fetch Error:", err);
      alert("Server error. Try again.");

    }

  };


  // ================= COD =================

  codBtn.onclick = async function () {

    console.log("üü© COD Clicked");

    if (!validate()) return;


    const formData = new FormData(form);
    formData.append("payment_mode", "COD");


    try {

      const res = await fetch("/checkout/place-order", {
        method: "POST",
        body: formData
      });


      const data = await res.json();

      console.log("üì¶ Response:", data);


      if (data.success) {

        alert(`
üéâ Order Confirmed!

Order ID: ${data.order_id}

Thank you for shopping üí™
        `);

        window.location.href = "/";

      } else {

        alert(data.message || "Order failed");

      }

    } catch (err) {

      console.error("‚ùå Fetch Error:", err);
      alert("Server error. Try again.");

    }

  };

});
</script>

{% endblock %}
