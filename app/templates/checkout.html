{% extends "base.html" %} 

{% block title %}Checkout - Protein Perks{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 py-12">

  <h1 class="text-3xl font-bold mb-8">Checkout</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">


    <!-- ================= FORM ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Shipping Details</h2>

      <form id="checkout-form">

        <input name="name" placeholder="Full Name" required class="input">

        <input name="email" type="email" placeholder="Email" required class="input">

        <input name="phone" placeholder="Phone" required class="input">

        <textarea name="address" placeholder="Address" required class="input"></textarea>

        <div class="grid grid-cols-2 gap-3">
          <input name="city" placeholder="City" required class="input">
          <input name="state" placeholder="State" required class="input">
        </div>

        <input name="pincode" placeholder="Pincode" required class="input">


        <!-- ================= UPI PAYMENT ================= -->

        <button id="upi-btn"
          type="button"
          class="w-full mt-3 bg-blue-600 text-white py-3 rounded">

          Pay via UPI

        </button>


        <!-- ================= COD ================= -->

        <button id="cod-btn"
          type="button"
          class="w-full mt-3 bg-green-600 text-white py-3 rounded">

          Cash On Delivery (+₹{{ cod_charge }})

        </button>

      </form>

    </div>


    <!-- ================= SUMMARY ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Order Summary</h2>

      {% for item in cart_items %}
      <div class="flex justify-between py-2 border-b">
        <span>{{ item.product.name }} ({{ item.quantity }})</span>
        <span>₹{{ item.subtotal }}</span>
      </div>
      {% endfor %}

      <div class="mt-4 text-lg font-bold flex justify-between">
        <span>Total</span>
        <span>₹{{ total }}</span>
      </div>

      <div class="mt-2 text-sm text-gray-600">
        COD Charge: ₹{{ cod_charge }}
      </div>

    </div>


  </div>

</div>

{% endblock %}



{% block extra_scripts %}

<script>

const form = document.getElementById("checkout-form");
const upiBtn = document.getElementById("upi-btn");
const codBtn = document.getElementById("cod-btn");


// ================= UPI =================

upiBtn.addEventListener("click", () => {

  const formData = new FormData(form);

  if (![...formData.values()].every(v => v.trim() !== "")) {
    alert("Please fill all details first");
    return;
  }

  alert(`
Pay via UPI

UPI ID: 9424862686@ybl

After payment,
Send screenshot on WhatsApp (7898928129- Harshil Majawdiya)
or enter Transaction ID.
`);

});


// ================= COD =================

codBtn.addEventListener("click", async () => {

  const formData = new FormData(form);

  // Save customer info
  const saveRes = await fetch("/checkout/create-order", {
    method: "POST",
    body: formData
  });

  const saveData = await saveRes.json();

  if (!saveData.success) {
    alert("Fill all details properly");
    return;
  }

  // Place COD order
  const res = await fetch("/checkout/cod", {
    method: "POST"
  });

  const data = await res.json();

  if (data.success) {

    alert(data.message);
    window.location.href = "/";

  } else {

    alert(data.message || "COD Failed. Try again.");

  }

});

</script>

{% endblock %}
