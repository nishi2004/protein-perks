{% extends "base.html" %}

{% block title %}Checkout - Protein Perks{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 py-12">

  <h1 class="text-3xl font-bold mb-8">Checkout</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">


    <!-- ================= FORM ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Shipping Details</h2>

      <form id="checkout-form">

        <input name="name" placeholder="Full Name" required class="input">

        <input name="email" type="email" placeholder="Email" required class="input">

        <input name="phone" placeholder="Phone" required class="input">

        <textarea name="address" placeholder="Address" required class="input"></textarea>

        <div class="grid grid-cols-2 gap-3">
          <input name="city" placeholder="City" required class="input">
          <input name="state" placeholder="State" required class="input">
        </div>

        <input name="pincode" placeholder="Pincode" required class="input">


        <!-- ONLINE PAYMENT -->
        <button id="pay-btn"
          type="submit"
          class="w-full mt-4 bg-indigo-600 text-white py-3 rounded">

          Pay Online ₹{{ total }}

        </button>


        <!-- COD -->
        <button id="cod-btn"
          type="button"
          class="w-full mt-3 bg-green-600 text-white py-3 rounded">

          Cash On Delivery (+₹{{ cod_charge }})

        </button>

      </form>

    </div>


    <!-- ================= SUMMARY ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Order Summary</h2>

      {% for item in cart_items %}
      <div class="flex justify-between py-2 border-b">
        <span>{{ item.product.name }} ({{ item.quantity }})</span>
        <span>₹{{ item.subtotal }}</span>
      </div>
      {% endfor %}

      <div class="mt-4 text-lg font-bold flex justify-between">
        <span>Total</span>
        <span>₹{{ total }}</span>
      </div>

      <div class="mt-2 text-sm text-gray-600">
        COD Charge: ₹{{ cod_charge }}
      </div>

    </div>


  </div>

</div>

{% endblock %}



{% block extra_scripts %}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

const form = document.getElementById("checkout-form");
const payBtn = document.getElementById("pay-btn");
const codBtn = document.getElementById("cod-btn");


// ================= ONLINE PAYMENT =================

form.addEventListener("submit", async (e) => {

  e.preventDefault();

  const formData = new FormData(form);

  const res = await fetch("/checkout/create-order", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  if (!data.success) {
    alert("Payment Failed");
    return;
  }

  const options = {
    key: data.key_id,
    amount: data.amount,
    currency: "INR",
    name: "ProteinPerks",
    order_id: data.order_id,

    handler: async function (response) {

      await fetch("/checkout/payment-success", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(response)
      });

      alert("Order Placed Successfully!");
      window.location.href = "/";
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();

});


// ================= COD =================

codBtn.addEventListener("click", async () => {

  const formData = new FormData(form);

  // Save customer info
  const saveRes = await fetch("/checkout/create-order", {
    method: "POST",
    body: formData
  });

  const saveData = await saveRes.json();

  if (!saveData.success) {
    alert("Fill all details properly");
    return;
  }

  // Place COD order
  const res = await fetch("/checkout/cod", {
    method: "POST"
  });

  const data = await res.json();

  if (data.success) {

    // ✅ SHOW BACKEND MESSAGE
    alert(data.message);

    window.location.href = "/";
  } 
  else {

    alert(data.message || "COD Failed. Try again.");

  }

});

</script>

{% endblock %}
