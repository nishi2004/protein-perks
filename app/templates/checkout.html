{% extends "base.html" %} 

{% block title %}Checkout - Protein Perks{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 py-12">

  <h1 class="text-3xl font-bold mb-8">Checkout</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">


    <!-- ================= FORM ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Shipping Details</h2>

      <form id="checkout-form">

        <input name="name" placeholder="Full Name" required class="input">

        <input name="email" type="email" placeholder="Email" required class="input">

        <input name="phone" placeholder="Phone" required class="input">

        <textarea name="address" placeholder="Address" required class="input"></textarea>

        <div class="grid grid-cols-2 gap-3">
          <input name="city" placeholder="City" required class="input">
          <input name="state" placeholder="State" required class="input">
        </div>

        <input name="pincode" placeholder="Pincode" required class="input">


        <!-- UPI TXN ID -->
        <input 
          name="txn_id"
          id="txn-id"
          placeholder="UPI Transaction ID (For UPI Only)"
          class="input mt-2"
        >


        <!-- ================= UPI ================= -->

        <button id="upi-btn"
          type="button"
          class="w-full mt-3 bg-blue-600 text-white py-3 rounded">

          Pay via UPI

        </button>


        <!-- ================= COD ================= -->

        <button id="cod-btn"
          type="button"
          class="w-full mt-3 bg-green-600 text-white py-3 rounded">

          Cash On Delivery (+₹{{ cod_charge }})

        </button>

      </form>

    </div>


    <!-- ================= SUMMARY ================= -->
    <div class="bg-white p-8 shadow rounded">

      <h2 class="text-xl font-bold mb-4">Order Summary</h2>

      {% for item in cart_items %}
      <div class="flex justify-between py-2 border-b">
        <span>{{ item.product.name }} ({{ item.quantity }})</span>
        <span>₹{{ item.subtotal }}</span>
      </div>
      {% endfor %}

      <div class="mt-4 text-lg font-bold flex justify-between">
        <span>Total</span>
        <span>₹{{ total }}</span>
      </div>

      <div class="mt-2 text-sm text-gray-600">
        COD Charge: ₹{{ cod_charge }}
      </div>

    </div>


  </div>

</div>

{% endblock %}



{% block extra_scripts %}

<script>

const form = document.getElementById("checkout-form");
const upiBtn = document.getElementById("upi-btn");
const codBtn = document.getElementById("cod-btn");
const txnInput = document.getElementById("txn-id");


// ================= VALIDATION =================

function validateForm() {

  const formData = new FormData(form);

  for (let val of formData.values()) {

    if (val.trim() === "") {
      alert("Please fill all details");
      return false;
    }

  }

  return true;
}


// ================= UPI =================

upiBtn.addEventListener("click", async () => {

  if (!validateForm()) return;


  alert(`
Pay via UPI

UPI ID: 9424862686@ybl

After payment,
Enter Transaction ID below
and click Pay via UPI again.
`);


  // Second click = submit order
  if (txnInput.value.trim() !== "") {

    const formData = new FormData(form);
    formData.append("payment_mode", "UPI");

    const res = await fetch("/checkout/place-order", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (data.success) {

      alert("Order Placed! Order ID: " + data.order_id);
      window.location.href = "/";

    } else {

      alert(data.message);

    }

  }

});


// ================= COD =================

codBtn.addEventListener("click", async () => {

  if (!validateForm()) return;

  const formData = new FormData(form);
  formData.append("payment_mode", "COD");

  const res = await fetch("/checkout/place-order", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  if (data.success) {

    alert("Order Placed! Order ID: " + data.order_id);
    window.location.href = "/";

  } else {

    alert(data.message);

  }

});

</script>

{% endblock %}
